<!DOCTYPE html>
<html>
<head>
    <title>CANnible</title>
</head>
<body>
  <table id="cantable">
    <tr><td><b>CAN Port</b></td><td><b>Message ID</b></td><td><b>Data</b></td></tr>
  </table>
  <hr/>
  <b id="title"></b><br/>
  <span id="hexspan" style="white-space:pre;"></span>
  <br/>
  <span id="binspan" style="white-space:pre;"></span>
</body>
<script>
  'use strict';
  
  var ws_url = window.location.host;
  if (!ws_url)
  {
    ws_url = "localhost";
  }
  let socket = new WebSocket("ws://" + ws_url + ":8081");
  
  var title = document.getElementById("title");
  var hex_row = document.getElementById("hexspan");
  var bin_row = document.getElementById("binspan");

  var watch_row = "";

  function putBase(elem)
  {
    var hex_str = "";
    var bin_str = "";

    elem.cells[2].innerText.split(" ").forEach(str => {
      hex_str += "   " + str + "    ";
      bin_str += (parseInt(str, 16).toString(2)).padStart(8, '0') + " ";
    })

    hex_row.innerText = hex_str;
    bin_row.innerText = bin_str;
  };

  function setBase(elem)
  {
    watch_row = elem.id;
    title.innerText = elem.id;
    putBase(elem);
  };

  socket.onopen = function(e)
  {
    socket.send("{\"can_port\": \"can0\"}");
  };
  
  socket.onclose = function(event)
  {
    if (event.wasClean)
    {
      alert(`Connection closed cleanly, code=${event.code} reason=${event.reason}`);
    } else 
    {
      alert('Connection died');
    }
  };
  
  socket.onerror = function(error)
  {
    alert(`[error] ${error.message}`);
  };

  socket.onmessage = function(event)
  {
    var msg = JSON.parse(event.data);
    if (msg.message == null)
    {
      var row = document.getElementById(msg.id);
      if (row != null)
      {
        row.cells[2].innerHTML = msg.data;
        if (watch_row == row.id)
        {
          putBase(row);
        }
      }
      else
      {
        var cantable = document.getElementById("cantable");
        row = cantable.insertRow(-1);
        row.id = msg.id;
        row.onclick = function() {setBase(this)};
        var cell0 = row.insertCell(0);
        var cell1 = row.insertCell(1);
        var cell2 = row.insertCell(2);
        cell0.innerHTML = msg.port;
        cell1.innerHTML = msg.id;
        cell2.innerHTML = msg.data;
      }
    }
    else
    {
      if (msg.success)
      {
        console.log(`${msg.message}`);
      }
      else
      {
        alert(`${msg.message}`);
      }
    }
  };
  </script>
</html>